<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>Index - AI Meal Planner</title>
  <meta name="description" content="Your personal AI meal planner for healthy and delicious meals.">
  <meta name="keywords" content="meal planner, AI, healthy eating, recipes">
  <link href="assets/img/favicon.png" rel="icon">
  <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/aos/aos.css" rel="stylesheet">
  <link href="assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
  <link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <link href="assets/css/main.css" rel="stylesheet">
</head>
<body class="index-page">
  <header id="header" class="header d-flex align-items-center sticky-top">
    <div class="container position-relative d-flex align-items-center justify-content-between">
      <a href="index.html" class="logo d-flex align-items-center me-auto me-xl-0">
        <h1 class="sitename">AI Meal Planner</h1>
        <span>.</span>
      </a>
      <nav id="navmenu" class="navmenu">
        <ul>
          <li><a href="plan.html">Meal Plan</a></li>
          <li><a href="index.html">History</a></li>
          <li><a href="profile.html" class="active">Profile</a></li>
          <li><a href="login.html">Logout</a></li>
        </ul>
        <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
      </nav>
      <a class="btn-getstarted" href="login.html">Get Started</a>
    </div>
  </header>

  <main class="main">
    <div class="container">
      <div class="card p-4 mt-5 shadow-lg">
        <div class="row">
          <div class="col-md-4 text-center">
            <img id="profileImage" class="img-thumbnail mb-3" src="assets/avatar-profile-icon-flat-style-female-user-profile-vector-illustration-isolated-background-women-profile-sign-business-concept_157943-38866.avif" alt="User profile picture" style="max-width: 200px;" />
            <input type="file" id="imageInput" class="form-control" accept="image/*" disabled />
          </div>
          <div class="col-md-8">
            <div class="mb-3">
              <label for="displayNameInput" class="form-label">Display Name</label>
              <input type="text" id="displayNameInput" class="form-control" placeholder="Your Name" readonly />
            </div>
            <div class="mb-3">
              <label for="emailDisplay" class="form-label">Email</label>
              <input type="email" id="emailDisplay" class="form-control" readonly />
            </div>
            <button id="editBtn" class="btn btn-secondary me-2" onclick="enableEditing()">Edit Profile</button>
            <button id="updateBtn" class="btn btn-primary" onclick="updateProfile()" disabled>Update Profile</button>
          </div>
        </div>
      </div>

      <div class="card p-4 mt-4 shadow">
        <h4>Plan Goal Summary</h4>
        <div id="goalSummary"></div>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script type="module">
    import { auth, db, storage } from './assets/js/firebase-config.js';
    import {
      onAuthStateChanged,
      updateProfile,
      signOut
    } from 'https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js';

    import {
      getDownloadURL,
      ref,
      uploadBytes
    } from 'https://www.gstatic.com/firebasejs/11.10.0/firebase-storage.js';

    import {
      collection,
      query,
      where,
      getDocs
    } from 'https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js';

    let currentUser = null;

    onAuthStateChanged(auth, async user => {
      if (!user) {
        window.location.href = "index.html";
      } else {
        currentUser = user;
        document.getElementById("displayNameInput").value = user.displayName || "";
        document.getElementById("emailDisplay").value = user.email || "";
        if (user.photoURL) {
          document.getElementById("profileImage").src = user.photoURL;
        }
        await loadGoalSummary();
      }
    });

    document.getElementById("imageInput").addEventListener("change", function () {
      if (this.files[0]) {
        document.getElementById("profileImage").src = URL.createObjectURL(this.files[0]);
      }
    });

    window.logout = async function () {
      await signOut(auth);
      window.location.href = 'index.html';
    };

    window.enableEditing = function () {
      document.getElementById("displayNameInput").removeAttribute("readonly");
      document.getElementById("imageInput").removeAttribute("disabled");
      document.getElementById("updateBtn").disabled = false;
      document.getElementById("editBtn").disabled = true;
    };

    window.updateProfile = async function () {
      const displayName = document.getElementById("displayNameInput").value.trim();
      const fileInput = document.getElementById("imageInput");
      const updateBtn = document.getElementById("updateBtn");

      if (!displayName) {
        Swal.fire("Error", "Display name is required.", "error");
        return;
      }

      updateBtn.disabled = true;
      updateBtn.textContent = "Updating...";

      try {
        let photoURL = currentUser.photoURL;

        if (fileInput.files[0]) {
          const storageRef = ref(storage, `profilePics/${currentUser.uid}`);
          await uploadBytes(storageRef, fileInput.files[0]);
          photoURL = await getDownloadURL(storageRef);
          document.getElementById("profileImage").src = photoURL;
        }

        await updateProfile(currentUser, { displayName, photoURL });

        Swal.fire("Success", "Profile updated successfully!", "success");

        // Re-disable inputs after update
        document.getElementById("displayNameInput").setAttribute("readonly", true);
        document.getElementById("imageInput").setAttribute("disabled", true);
        document.getElementById("editBtn").disabled = false;
      } catch (error) {
        console.error(error);
        Swal.fire("Error", "Something went wrong. Please try again.", "error");
      } finally {
        updateBtn.disabled = true;
        updateBtn.textContent = "Update Profile";
      }
    };

    async function loadGoalSummary() {
      const q = query(
        collection(db, "plans"),
        where("userId", "==", currentUser.uid)
      );
      const snapshot = await getDocs(q);
      const summary = {};

      snapshot.forEach(doc => {
        const goal = doc.data().goal || "Unknown";
        summary[goal] = (summary[goal] || 0) + 1;
      });

      const container = document.getElementById("goalSummary");
      container.innerHTML = `<h4>Plan Goal Summary</h4>`;

      if (Object.keys(summary).length === 0) {
        container.innerHTML += `<p>No plans yet.</p>`;
        return;
      }

      google.charts.load('current', { packages: ['corechart'] });
      google.charts.setOnLoadCallback(() => {
        const chartData = [['Goal', 'Count']];
        for (let goal in summary) {
          chartData.push([goal, summary[goal]]);
        }

        const data = google.visualization.arrayToDataTable(chartData);
        const options = {
          title: 'Your Plan Goals',
          pieHole: 0.4,
          width: 400,
          height: 300
        };

        const chartDiv = document.createElement("div");
        chartDiv.id = "goalChart";
        container.appendChild(chartDiv);

        const chart = new google.visualization.PieChart(chartDiv);
        chart.draw(data, options);
      });
    }
  </script>

  <a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>
  <div id="preloader"></div>
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/vendor/php-email-form/validate.js"></script>
  <script src="assets/vendor/aos/aos.js"></script>
  <script src="assets/vendor/glightbox/js/glightbox.min.js"></script>
  <script src="assets/vendor/purecounter/purecounter_vanilla.js"></script>
  <script src="assets/vendor/swiper/swiper-bundle.min.js"></script>
  <script src="assets/js/main.js"></script>
</body>
</html>
